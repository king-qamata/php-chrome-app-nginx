# ----------------------------
# Stage 1: Composer Builder
# ----------------------------
FROM composer:2.5 AS builder
WORKDIR /app

# Copy composer files
COPY composer.json ./

# Install dependencies
RUN composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

# ----------------------------
# Stage 2: Azure-optimized PHP-FPM with Nginx
# ----------------------------
FROM mcr.microsoft.com/appsvc/php:8.4-fpm_20250728.2.tuxprod

# Avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install additional system dependencies (Chrome, ChromeDriver, etc.)
RUN apt-get update && apt-get upgrade -y && apt-get install -y --no-install-recommends \
    wget unzip jq \
    libnss3 libgconf-2-4 libxi6 libgtk-3-0 \
    libx11-xcb1 libxcomposite1 libxdamage1 libxrandr2 \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Google Chrome
RUN wget -qO /tmp/google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb && \
    apt-get update && \
    apt-get install -y /tmp/google-chrome.deb && \
    rm -rf /tmp/google-chrome.deb

# Install ChromeDriver
RUN JSON_URL="https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json" && \
    DOWNLOAD_URL=$(curl -sSL $JSON_URL | jq -r '.channels.Stable.downloads.chromedriver[] | select(.platform == "linux64") | .url') && \
    wget -O /tmp/chromedriver.zip "$DOWNLOAD_URL" && \
    unzip /tmp/chromedriver.zip -d /tmp/ && \
    mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/ && \
    chmod +x /usr/local/bin/chromedriver && \
    rm -rf /tmp/*

# Copy application files from builder to Azure directory
COPY --from=builder /app/vendor /home/site/wwwroot/vendor
COPY src/ /home/site/wwwroot/
COPY composer.json /home/site/wwwroot/

# Set proper permissions for Azure directory (Azure images use a specific user)
RUN chmod -R 755 /home/site/wwwroot

# Copy custom PHP configuration if needed
# COPY php.ini /usr/local/etc/php/conf.d/999-custom.ini

# Note: Azure PHP image already includes:
# - Proper logging to /home/LogFiles
# - Correct PHP-FPM and nginx configuration
# - Startup script for Azure App Service
# - Health check endpoints

# The Azure PHP image already exposes port 80 and has the correct CMD
# We don't need to modify the entrypoint as Azure's image is already optimized





================================================================================




# ----------------------------
# Stage 1: Composer Builder
# ----------------------------
FROM composer:2.5 AS builder
WORKDIR /app

# Copy composer files
COPY composer.json ./

# Install dependencies
RUN composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

# ----------------------------
# Stage 2: Azure-optimized PHP-FPM with Nginx
# ----------------------------
FROM mcr.microsoft.com/appsvc/php:8.3-fpm_20251016.4.tuxprod

# Avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive \
    PORT=80 \
    WEBSITES_PORT=80 \
    APPSETTING_WEBSITES_PORT=80

# Install additional system dependencies for Chrome
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget unzip jq \
    libnss3 libgconf-2-4 libxi6 libgtk-3-0 \
    libx11-xcb1 libxcomposite1 libxdamage1 libxrandr2 \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Google Chrome
RUN wget -qO /tmp/google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb && \
    apt-get update && \
    apt-get install -y /tmp/google-chrome.deb && \
    rm -rf /tmp/google-chrome.deb

# Install ChromeDriver
RUN JSON_URL="https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json" && \
    DOWNLOAD_URL=$(curl -sSL $JSON_URL | jq -r '.channels.Stable.downloads.chromedriver[] | select(.platform == "linux64") | .url') && \
    wget -O /tmp/chromedriver.zip "$DOWNLOAD_URL" && \
    unzip /tmp/chromedriver.zip -d /tmp/ && \
    mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/ && \
    chmod +x /usr/local/bin/chromedriver && \
    rm -rf /tmp/*

# Create additional directories for Chrome profiles
RUN mkdir -p /tmp/chrome-profiles

# Set proper permissions for Chrome directories
RUN chmod -R 777 /tmp/chrome-profiles

# Copy application files from builder to Azure directory
COPY --from=builder /app/vendor /home/site/wwwroot/vendor
COPY src/ /home/site/wwwroot/
COPY composer.json /home/site/wwwroot/

# Set proper permissions for Azure directory
RUN chmod -R 755 /home/site/wwwroot

# Copy custom configuration files (if they exist)
# Note: Azure PHP image already has nginx and supervisor configured
# We'll override with our custom configurations if needed

# Copy custom nginx configuration if you have one
#COPY nginx-azure.conf /etc/nginx/sites-available/default 2>/dev/null || :

# Copy custom supervisor configuration for ChromeDriver
COPY supervisord-chromedriver.conf /etc/supervisor/conf.d/chromedriver.conf

# Copy custom PHP configuration if needed
COPY php-azure.ini /usr/local/etc/php/conf.d/999-custom.ini

# Create startup script for Chrome profile cleanup
COPY startup.sh /startup.sh
RUN chmod +x /startup.sh

# Declare volume for Azure persistent storage
VOLUME ["/home"]

WORKDIR /home/site/wwwroot

EXPOSE 80

# Use the existing Azure startup mechanism with our customizations
CMD ["/startup.sh"]

=================================================================================


<?php
require __DIR__ . '/vendor/autoload.php';

use Facebook\WebDriver\Chrome\ChromeOptions;
use Facebook\WebDriver\Remote\DesiredCapabilities;
use Facebook\WebDriver\Remote\RemoteWebDriver;

function checkChromeDriver() {
    echo "Checking ChromeDriver status...\n";
    
    // Check if process is running
    $processCheck = shell_exec("pgrep -f chromedriver");
    if (empty($processCheck)) {
        echo "❌ ChromeDriver process is not running\n";
        return false;
    }
    echo "✓ ChromeDriver process is running (PID: " . trim($processCheck) . ")\n";
    
    // Check if port is listening
    $portCheck = shell_exec("netstat -tuln 2>/dev/null | grep :9515 || ss -tuln 2>/dev/null | grep :9515");
    if (empty($portCheck)) {
        echo "❌ Port 9515 is not listening\n";
        return false;
    }
    echo "✓ Port 9515 is listening\n";
    
    // Check HTTP endpoint
    $ch = curl_init('http://localhost:9515/status');
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 5);
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    if ($httpCode !== 200) {
        echo "❌ ChromeDriver HTTP status endpoint returned code: $httpCode\n";
        return false;
    }
    
    echo "✓ ChromeDriver HTTP endpoint is accessible\n";
    
    if ($response) {
        $data = json_decode($response, true);
        if (isset($data['value']['ready'])) {
            echo "✓ ChromeDriver is ready: " . ($data['value']['ready'] ? 'true' : 'false') . "\n";
        }
    }
    
    return true;
}

// Main execution
echo "Starting Chrome WebDriver test...\n";

// First, check if ChromeDriver is running
if (!checkChromeDriver()) {
    die("ChromeDriver is not properly running. Please check the container logs.\n");
}

// Create unique profile directory
$userDataDir = '/tmp/chrome-profiles/profile-' . uniqid();
if (!is_dir($userDataDir)) {
    mkdir($userDataDir, 0755, true);
}

echo "Using profile directory: $userDataDir\n";

$options = new ChromeOptions();
$options->addArguments([
    '--headless=new',
    '--no-sandbox',
    '--disable-dev-shm-usage',
    '--disable-gpu',
    '--disable-software-rasterizer',
    '--remote-debugging-port=0',
    '--user-data-dir=' . $userDataDir,
    '--disable-blink-features=AutomationControlled',
    '--no-first-run',
    '--disable-extensions',
    '--disable-plugins'
]);

$capabilities = DesiredCapabilities::chrome();
$capabilities->setCapability(ChromeOptions::CAPABILITY, $options);

$driver = null;

try {
    echo "Connecting to ChromeDriver...\n";
    
    // Try to connect with retry logic
    $maxRetries = 3;
    $retryCount = 0;
    
    while ($retryCount < $maxRetries) {
        try {
            $driver = RemoteWebDriver::create('http://localhost:9515', $capabilities, 30000, 30000);
            echo "✓ Successfully connected to ChromeDriver\n";
            break;
        } catch (Exception $e) {
            $retryCount++;
            if ($retryCount === $maxRetries) {
                throw $e;
            }
            echo "Connection attempt $retryCount failed, retrying...\n";
            sleep(2);
        }
    }
    
    echo "Navigating to example.com...\n";
    $driver->get('https://example.com');
    
    $title = $driver->getTitle();
    echo "✓ Page title: " . $title . "\n";
    
    echo "Closing browser...\n";
    $driver->quit();
    $driver = null;
    
    echo "✓ Test completed successfully!\n";
    
} catch (Exception $e) {
    echo "❌ Error: " . $e->getMessage() . "\n";
    
    // Additional debug info
    echo "Error type: " . get_class($e) . "\n";
    
    if (strpos($e->getMessage(), 'Failed to connect') !== false) {
        echo "This is a connection error. Checking ChromeDriver status again...\n";
        checkChromeDriver();
        
        // Show recent logs
        echo "Last 10 lines of ChromeDriver log:\n";
        $logLines = shell_exec("tail -10 /home/LogFiles/chromedriver.log 2>/dev/null") ?: "No log file found\n";
        echo $logLines;
    }
    
} finally {
    // Clean up driver
    if ($driver instanceof RemoteWebDriver) {
        try {
            $driver->quit();
        } catch (Exception $e) {
            // Ignore quit errors
        }
    }
    
    // Clean up profile directory
    if (isset($userDataDir) && is_dir($userDataDir)) {
        shell_exec("rm -rf " . escapeshellarg($userDataDir) . " 2>/dev/null");
        echo "Cleaned up profile directory\n";
    }
}